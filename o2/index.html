<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Simple sample - gin samples</title>
</head>
<body>
<div id="device"></div>
<script type="text/javascript" src="gin.js"></script>
<script type="text/javascript" src="back.js"></script>
<script type="text/javascript">

$G('device', {
    width: 400,
    height: 400,
    fps: 32,
}, {
    start: function() {
        var audio = new Audio();
        audio.src = 'back.mp3';
        audio.play();

        console.log(JSON.stringify(bms.frames));
        this.data('rad', 2 * Math.random())
        .data('radDelta', -0.004)
        .data('color', 0)
        .data('keyLightHeight', 10)
        .data('singleNoteHeight', 6)
        .data('activeNotes', {})
        .data('frame', 0)
        .data('audio', audio)
        .data('colorDelta', 8);
    },
    render: function(e) {
        var keySettings = [0x53, 0x44, 0x46, 0x20, 0x4a, 0x4b, 0x4c]; //'d', 'f', 'g', ' ', 'j', 'k', 'l' 
        var ctx = e.context,
            audio = this.data('audio'),
            rad = this.data('rad'),
            radDelta = this.data('radDelta'),
            color = this.data('color'),
            keyLightHeight = this.data('keyLightHeight'),
            singleNoteHeight = this.data('singleNoteHeight'),
            activeNotes = this.data('activeNotes'),
            frame = this.data('frame'),
            colorDelta = this.data('colorDelta'),
            r = rad * Math.PI;

//audio.pause();

// audio.currentTime = 0;
// audio.play();
        
        ctx.save();
        ctx.clearRect(0, 0, this.width(), this.height());
        ctx.beginPath();
        ctx.lineWidth = 20;
        ctx.strokeStyle = 'rgb(255,' + color + ',' + color + ')';
        ctx.moveTo(100, 100);
        ctx.lineTo(100 + Math.cos(r) * 80, 100 + Math.sin(r) * 80);
        ctx.arc(100, 100, 80, r, r + 5/3 * Math.PI, false);
       
        blockSize = keySettings.length;
        blockWidth = this.width() / blockSize;
        for (var i=0; i<blockSize; i++) {
          keyCode = keySettings[i];
          if (e.keyState[keyCode]) {
            ctx.fillRect(i*blockWidth, this.width() - keyLightHeight, blockWidth, keyLightHeight);
          }
        }
        if (bms.frames[frame]) {
          activeNotes[frame] = bms.frames[frame]
        }
        if (console) {
          var str = JSON.stringify(e.keyState);
          if (str != '{}')
          console.log(JSON.stringify(e.keyState));
          if (activeNotes.length) console.log(JSON.stringify(activeNotes));
        }
        
        newNotes =  {}
        for (var i in activeNotes) {
          height = (frame - i)*5;
          if (height >= 0 && height + singleNoteHeight <= this.height()) {
            for(var p in activeNotes[i]) {
              pos = (p-11)
              if (pos >= 0 && pos < 7)
              ctx.fillRect(blockWidth*pos, height, blockWidth, singleNoteHeight);
            }
            newNotes[i] = activeNotes[i]
          }
        }
        ctx.stroke();
        ctx.restore();
        
        color += colorDelta;
        rad += radDelta;
        this.data('rad', rad)
        .data('radDelta', rad >= 2 || rad <= 0? -radDelta: radDelta)
        .data('color', color)
        .data('frame', (frame + 1) )
        .data('activeNotes', newNotes )
        .data('colorDelta', color >= 200 || color <= 0? -colorDelta: colorDelta);
    }
})
;

</script>
</body>
</html>
