<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Simple sample - gin samples</title>
</head>
<body>
<div id="device"></div>
<script type="text/javascript" src="gin.js"></script>
<script type="text/javascript" src="back.js"></script>
<script type="text/javascript">

$G('device', {
    width: 600,
    height: 600,
    fps: 32,
}, {
    start: function() {
        var audio = new Audio();
        audio.src = 'back.mp3';
        audio.play();

        console.log(JSON.stringify(bms.frames));
        this
        .data('color', 0)
        .data('keyLightHeight', 10)
        .data('singleNoteHeight', 6)
        .data('activeNotes', {})
        .data('frame', 0)
        .data('audio', audio)
        .data('colorDelta', 8);
    },
    render: function(e) {
        var keySettings = [0x53, 0x44, 0x46, 0x20, 0x4a, 0x4b, 0x4c]; //'d', 'f', 'g', ' ', 'j', 'k', 'l' 
        var ctx = e.context,
            audio = this.data('audio'),
            color = this.data('color'),
            keyLightHeight = this.data('keyLightHeight'),
            singleNoteHeight = this.data('singleNoteHeight'),
            activeNotes = this.data('activeNotes'),
            frame = this.data('frame');

//audio.pause();

// audio.currentTime = 0;
// audio.play();
        
        ctx.save();
        ctx.clearRect(0, 0, this.width(), this.height());
      
        blockSize = keySettings.length;
        blockWidth = this.width() / blockSize;
        for (var i=0; i<blockSize; i++) {
          keyCode = keySettings[i];
          if (e.keyState[keyCode]) {
            ctx.fillRect(i*blockWidth, this.width() - keyLightHeight, blockWidth, keyLightHeight);
          }
        }
        if (bms.frames[frame]) {
          activeNotes[frame] = bms.frames[frame]
        }
        if (console) {
          var str = JSON.stringify(e.keyState);
          if (str != '{}')
          console.log(JSON.stringify(e.keyState));
          if (activeNotes.length) console.log(JSON.stringify(activeNotes));
        }
        
        newNotes =  {}
        for (var i in activeNotes) {
          height = (frame - i)*5;
          if (height >= 0 && height + singleNoteHeight <= this.height()) {
            for(var p in activeNotes[i]) {
              keyMap = {16:0,11:1,12:2,13:3,14:4,15:5,18:6};
              if ((p>=11 && p<=15) || (p>=18 && p<=19)) {
                pos = keyMap[p]
              }
              else {
                continue;
              }
              if (pos >= 0 && pos < 7) {
                color = ['#C0C0C0', '#0000A0', '#C0C0C0', '#FF8040', '#C0C0C0', '#0000A0', '#C0C0C0'];
                ctx.fillStyle   = color[pos];
                ctx.fillRect(blockWidth*pos, height, blockWidth, singleNoteHeight);
              }
            }
            newNotes[i] = activeNotes[i]
          }
        }
        ctx.stroke();
        ctx.restore();
        
        this
        .data('color', color)
        .data('frame', (frame + 1) )
        .data('activeNotes', newNotes )
    }
})
;

</script>
</body>
</html>
